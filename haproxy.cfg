# Copyright 2021, 2023 HCL Technologies
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# DX Docker-Compose HAProxy POC
# Enhances existing config with: Cookie Security, Session Tracking,
#                                  Stats Dashboard, Failover, Logging
# =============================================================================

# ------------------------------------------------------------------------------
# GLOBAL SETTINGS (unchanged, plus stats socket)
# ------------------------------------------------------------------------------
global
    maxconn 50000
    log stdout format raw local0 info
    nbthread 4
    # [NEW] Stats socket for admin access (useful for querying stick tables)
    # NOTE: Using /tmp because the container runs as non-root (dx_user)
    stats socket /tmp/haproxy.sock mode 660 level admin
    # [NEW] TCP stats socket — queryable without socat
    stats socket *:9999 level admin

# ------------------------------------------------------------------------------
# DEFAULTS (enhanced with failover and custom logging)
# ------------------------------------------------------------------------------
defaults
    timeout connect 10s
    timeout client 1200s
    timeout server 1200s
    log global
    mode http
    # NOTE: option httplog removed — custom log-format below overrides it
    # [NEW - FAILOVER] Re-dispatch to another server if current one is down
    option redispatch
    # [UNCHANGED] roundrobin is fine for 2 DX Core instances
    balance roundrobin
    # [NEW - LOGGING] Custom log format with source IP removed (privacy)
    log-format "[%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

# ------------------------------------------------------------------------------
# DNS RESOLVER (explicit Docker DNS)
# ------------------------------------------------------------------------------
resolvers docker-dns
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    accepted_payload_size 8192
    hold valid 5s

# ------------------------------------------------------------------------------
# [NEW - SESSION TRACKING] Persist stick tables across HAProxy reloads
# ------------------------------------------------------------------------------
peers localPeer
    peer local 127.0.0.1:10000

# ------------------------------------------------------------------------------
# [NEW - STATS DASHBOARD] Visual verification of backends and sessions
# Access at http://localhost:8404/stats
# ------------------------------------------------------------------------------
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

# ------------------------------------------------------------------------------
# [NEW - HEALTH PROBE] Returns 200 OK for container health checks
# Internal only — port 8888 is not exposed in dx.yaml
# ------------------------------------------------------------------------------
frontend probe
    no log
    bind *:8888
    http-request return status 200 content-type "text/plain" string "OK"

# ------------------------------------------------------------------------------
# FRONTEND: Main DX Traffic
# [UNCHANGED] Path routing + [NEW] User session tracking
# ------------------------------------------------------------------------------
frontend dx
    bind :8081

    # ------------------------------------------------------------------
    # [NEW - USER SESSION TRACKING] Track per-user request rates
    # NOTE: http-request rules are placed before use_backend to match
    #       HAProxy's actual processing order (http-request always runs first)
    # ------------------------------------------------------------------
    # Build a unique fingerprint per user: source IP + User-Agent + X-Forwarded-For
    stick-table type string len 180 size 1m expire 30m store http_req_rate(30m),gpc0 peers localPeer
    http-request set-header X-Concat --%[src]_%[req.fhdr(User-Agent)]_%[req.fhdr(X-Forwarded-For,-1)]--
    http-request track-sc0 req.fhdr(X-Concat)

    # ------------------------------------------------------------------
    # [UNCHANGED] Path routing — same 4 routes as original
    # ------------------------------------------------------------------
    use_backend dam if { path -m reg ^/dx/(api|ui)/dam/ }
    use_backend content if { path_beg /dx/ui/content/ }
    use_backend image-processor if { path_beg /dx/api/image-processor/ }
    use_backend ring-api if { path_beg /dx/api/core/ }

    # ------------------------------------------------------------------
    # [UNCHANGED] Default: all unmatched traffic goes to Core
    # ------------------------------------------------------------------
    default_backend core-dx-home

# ------------------------------------------------------------------------------
# BACKEND: Core DX (2 instances: core + core2)
# [UNCHANGED] Load balancing + Sticky sessions
# [ENHANCED] Cookie security (httponly added)
# ------------------------------------------------------------------------------
backend core-dx-home
    # [NEW] Detect session-related cookies in backend responses
    acl has_jsession_cookie res.cook(JSESSIONID) -m found
    acl has_ltpa_cookie res.cook(LtpaToken2) -m found

    # [ENHANCED - COOKIE SECURITY] Added httponly to existing DXSRVID cookie
    # - insert: HAProxy creates the cookie (not the app)
    # - indirect: cookie is not passed to the backend server
    # - nocache: adds Cache-Control: no-cache to responses that set this cookie
    # - httponly: not accessible via JavaScript (NEW)
    cookie DXSRVID insert indirect nocache httponly

    # [UNCHANGED] 2 static Core servers
    server core1 dx-core:10039 check resolvers docker-dns init-addr none cookie core1
    server core2 dx-core-2:10039 check resolvers docker-dns init-addr none cookie core2

# ------------------------------------------------------------------------------
# BACKEND: Digital Asset Management (unchanged)
# ------------------------------------------------------------------------------
backend dam
    server dam dx-dam:3001 check resolvers docker-dns init-addr none

# ------------------------------------------------------------------------------
# BACKEND: Content Composer (unchanged)
# ------------------------------------------------------------------------------
backend content
    server content dx-cc:3000 check resolvers docker-dns init-addr none

# ------------------------------------------------------------------------------
# BACKEND: Image Processor (unchanged)
# ------------------------------------------------------------------------------
backend image-processor
    server image-processor dx-image-processor:8080 check resolvers docker-dns init-addr none

# ------------------------------------------------------------------------------
# BACKEND: Ring API (unchanged)
# ------------------------------------------------------------------------------
backend ring-api
    server ring-api dx-ringapi:3000 check resolvers docker-dns init-addr none
